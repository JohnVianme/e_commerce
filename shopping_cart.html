<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="/styles.css">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:ital,wght@0,300..800;1,300..800&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
		<title>Shoping Cart</title>
		<script>
			function initPage(){
				var username = window.localStorage.getItem('username')
				var acctType = window.localStorage.getItem('acctType')
				
				if(!username){
					alert('You must be logged in to view your cart.')
					window.location.href = '/login'
					return
				}
				var header = document.getElementById('cart_header')
				header.innerText = username + "'s Shopping Cart"
				
				var list = document.getElementById('cartList')
				list.innerHTML = "<li>Loading cart...</li>"
				
				fetch("/api/cart/" + encodeURIComponent(username),{method:"get"})
				.then(function (res){
					return res.json()
				})
				.then(function (data){
					var cart = data.cart || []
					list.innerHTML = ""
					
					if(cart.length == 0){
						list.innerHTML = "<li>Your cart is empty.</li>"
						return
					}
					
					for(var i = 0; i < cart.length; i++){
						var item = cart[i]
						var li = document.createElement("li")
						var text = item.name || "Unnamed Product"
						if(item.price != undefined){
							text += " - $" + item.price
						}
						if(item.description){
							text += " (" + item.description + ")"
						}
						
						var span = document.createElement("span")
						span.innerText = text + " "
						
						var btn = document.createElement("button")
						btn.innerText = "Remove"
						(function (id) {
							btn.onclick = function (){
								rm_item(id)
							}
						})(item._id)
						
						li.appendChild(span)
						li.appendChild(btn)
						list.appendChild(li)
					}
				})
				.catch(function (err){
					console.log(err)
					list.innerHTML = "<li>Error fetching cart.</li>"
				})
			}
			function rm_item(itemId){
				var username = window.localStorage.getItem('username')
				if(!username){
					alert("You must be logged in to view your cart")
					window.location.href = '/login'
					return
				}
				fetch('/api/cart/remove',{
					method: "post",
					headers:{"Content-Type":"application/json"},
					body: JSON.stringify({username:username, itemId:itemId}),
				})
				.then(function(res){
					return res.json()
				})
				.then(function(data){
					if(data.success){
						initPage()
					}else{
						alert(data.message || "Error: unable to remove item.")
					}
				})
				.catch(function(err){
					console.log(err)
					alert("Error removing item.")
				})
			}
			function purchase(){
				var username = window.localStorage.getItem('username')
				if(!username){
					alert('You must be logged in to view cart.')
					window.location.href = '/login'
					return
				}
				fetch("/api/cart/purchase",{
					method:"post",
					headers:{"Content-Type":"application/json"},
					body: JSON.stringify({username:username})
				})
				.then(function(res){
					return res.json()
				})
				.then(function(data){
					if(data.success){
						alert("Purcase complete! Thank you for your order.")
						initPage()
					} else {
						alert(data.message || "Unable to complete your purchase.")
					}
				})
				.catch(function(err){
					console.log(err)
					alert('Error completing purchase.')
				})
			}
		</script>
	</head>
	<body onload="initPage()">
		<header>
			<h1 id="cart_header">Buyer's Shopping Cart</h1>
		</header>
		<nav>
			<a href="/home">Home</a>
			<a href="/login">Login</a>
		</nav>
		<div class="pageText">
			<h2>Your Shopping Cart: </h2>
			<ul id="cartList">
				<li>No products in your shopping cart yet! Please feel free to browse from our wonderfull sellers!</li>
			</ul>
		</div>
		<input class="bottomButtons" type="button" onclick="purchase()" value="Check out">
		<footer>
		</footer>
	</body>
</html>