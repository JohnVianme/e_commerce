<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:ital,wght@0,300..800;1,300..800&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <title>Seller Store</title>
    <script>
      function initSellerPage() {
        var pathParts = window.location.pathname.split("/");
        var username = decodeURIComponent(pathParts[pathParts.length - 1]);

        var header = document.getElementById("storeHeader");
        header.innerText = username + "'s Store";
        var itemList = document.getElementById("itemList");
        itemList.innerHTML = "<li>Fetching Items...</li>";

        fetch("/api/seller/" + encodeURIComponent(username), { method: "get" })
          .then((res) => {
            return res.json();
          })
          .then((data) => {
            if (!data || !Array.isArray(data.shelf)) {
              itemList.innerHTML = "<li>No Items listed yet.</li>";
              return;
            }
            var shelf = data.shelf;

            itemList.innerHTML = "";

            if (shelf.length == 0) {
              itemList.innerHTML = "<li>No items listed yet.</li>";
              return;
            }

            for (var i = 0; i < shelf.length; i++) {
              var item = shelf[i];
              var li = document.createElement("li");
              var text = item.name || "Unnamed item listing";

              if (item.price != undefined) {
                text += " - $" + item.price;
              }
              if (item.description) {
                text += " (" + item.description + ")";
              }
              // use a p to hold the text
              var p = document.createElement("p");
              p.innerText = text;
              li.appendChild(p);

              // Add to Cart button
              var btn = document.createElement("button");
              btn.innerText = "Add to Cart";
              btn.setAttribute("data-item-id", item._id);
              btn.onclick = function (event) {
                var id = event.currentTarget.getAttribute("data-item-id");
                addToCartFetch(
                  localStorage.getItem("username"),
                  id,
                  item.seller
                );
              };
              li.appendChild(btn);

              itemList.appendChild(li);
            }
          })
          .catch((err) => {
            console.log(err);
            itemList.innerHTML = "<li>Error loading items.</li>";
          });
      }

      // Fetch function for adding item to cart
      async function addToCartFetch(username, itemId, seller) {
        try {
          var res = await fetch("/api/cart/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: username,
              itemId: itemId,
              seller: seller,
            }),
          });
          try {
            let data = await res.json();
            if (!data.ok) {
              alert(data.message || "Unable to add item, are you logged in?");
              window.location.href = "/login";
            } else {
              alert(data.message || "Item added to Cart!");
            }
          } catch (error) {
            console.log("Something went wrong in seller.html");
            console.log(error);
          }
        } catch (err) {
          console.error(err);
          alert("Error adding item to cart.");
        }
      }
    </script>
  </head>
  <body onload="initSellerPage()">
    <header>
      <h1 id="storeHeader">Seller Store</h1>
    </header>
    <nav>
      <a href="/home">Home</a>
      <a href="/login">Login</a>
    </nav>

    <div class="pageText">
      <h2>Items for sale</h2>
      <ul id="itemList">
        <li>Loading...</li>
      </ul>
    </div>
  </body>
</html>
